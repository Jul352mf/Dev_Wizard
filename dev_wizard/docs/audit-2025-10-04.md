# Dev Wizard Repository Audit (2025-10-04)

> Purpose: Provide the Copilot Cloud Run agent with an authoritative snapshot of the current implementation versus the canonical design (`architecture.md`, `PRD.md`, `roadmap.md`, `security_strategy.md`). This document identifies what exists, what is missing, technical debt hotspots, and a prioritized action plan.

---
## 1. High-Level Summary
The repository contains a functional scaffold for a dual-surface application (Next.js + Express API + early Electron wiring). Core runtime capabilities are only partially implemented; many features described in the canonical docs are represented as stubs or not yet started. The current code emphasises early API endpoints (projects, tasks placeholder, secrets placeholder, flags) and UI pages with hardcoded data rather than dynamic integration.

State classification:
- Implemented (basic): Feature flag loader & endpoint, sample DB (in-memory / sqlite-like), root API index, health route.
- Implemented (scaffold/stub): Tasks model & endpoints (rudimentary), secrets listing (masked), WebSocket echo server, Electron scripts, docs backlog (`docs/todos.md`).
- Not implemented: Environment matrix loader, real project scanning (heuristics), task runner concurrency & logs streaming, secrets keychain integration, MCP/LangGraph proxy, security layers (audit, mTLS, FIDO2), decision log automation, dynamic frontend data binding, database persistence aligned to PostgreSQL strategy.

Risk: Without dynamic frontend + robust backend services, the Copilot automation flows (create → configure → run → commit) cannot yet be validated end‑to‑end.

---
## 2. Canonical Requirements vs Current State
| Domain | Canonical Expectation | Current Implementation | Gap Severity |
| ------ | --------------------- | ---------------------- | ------------ |
| Feature Flags | `config/features.json` + schema + runtime gating | Loader with schema (Zod), endpoint `/api/flags` | LOW (allow remote override later) |
| Environment Matrix | `infra/environments.yaml` parsing & endpoint | Missing entirely | HIGH |
| Project Discovery | Scan workspace; detect multipile project types | Manual seed + simple watch; no heuristics | HIGH |
| Task Runner | Concurrency, logs, status transitions, WebSocket events | Static tasks seeded; no execution engine | HIGH |
| Secrets Mgmt | Keychain adapters + Configu sync + CRUD | Basic in-memory/DB mask only (no providers) | HIGH |
| LangGraph / MCP Proxy | Endpoints for graphs, tool invocation, mTLS | Not present | HIGH |
| Security (Keychain, MFA, mTLS) | Pluggable providers + audit logging | None (only placeholders) | HIGH |
| Decision Log Automation | Append ADR-style entries automatically | Not implemented | MEDIUM |
| Electron Integration | Launch wrapped UI + packaged build | Scripts exist, no deep IPC bridging yet | MEDIUM |
| Database Strategy | PostgreSQL primary; SQLite dev fallback | Likely in-memory or lightweight local only | MEDIUM |
| Frontend Data Binding | Dynamic fetch for projects, tasks, secrets, flags | Mostly hardcoded UI placeholders | HIGH |
| Tests | Unit + integration tests + coverage baseline | None present | HIGH |
| CI | Lint + docs verification + smoke tests | Basic workflow (lint + verify) exists | MEDIUM |
| Logging & Observability | Structured logger + redaction | console.log only | MEDIUM |
| Command Palette | Global action launcher | Missing | LOW |
| Templates / Scaffolding | Project generation wizard | Missing | LOW |

Severity Legend: HIGH (blocks core MVP), MEDIUM (important for reliability / completeness), LOW (enhancement / polish).

---
## 3. Inventory Snapshot
### 3.1 Code & Structure
- Frontend: Next.js app (`app/` pages for dashboard, projects, actions, secrets, settings) – currently client components with stub data.
- Backend: Express server (`api/index.ts`) with endpoints: `/api/health`, `/api/projects`, `/api/tasks`, `/api/secrets`, `/api/flags`, `/api/scan`, `/api/scan/directory`, plus root `/` HTML index.
- Config: `config/features.example.json`, `config/features.schema.json` (no committed `features.json` yet), missing environment matrix loader.
- Feature Flags: Loader in `api/lib/config/loadFeatureFlags.ts` with caching, optional `$schema`.
- Database: In-memory style modules (likely backed by simple arrays or lightweight local DB) – not Postgres.
- WebSocket: Basic echo + project_changed broadcast placeholder.
- Electron: Scripts exist (`electron:` npm scripts) but IPC abstractions not established.

### 3.2 Tooling & Scripts
- NPM scripts: `dev`, `api:dev`, `dev:all`, `electron:*`, `api:compile`.
- CI: Workflow present performing lint + docs verification + flag load smoke (needs test integration later).
- No test framework configured (Vitest/Jest absent).

### 3.3 Documentation
- Canonical docs present under `dev_wizard/docs/`.
- Backlog file: `docs/todos.md` with comprehensive task plan (good coverage).
- Missing: Development guide, security interim notes, decision log automation, OpenAPI spec.

### 3.4 Configuration & Env
- No `.env.example` or environment loader for runtime config (ports, external endpoints).
- No environment matrix YAML parser.

### 3.5 Security Status
- No keychain integration, audit logging, or FIDO2 workflow code.
- Secrets endpoint masks but does not enforce access controls.

### 3.6 Testing & Quality
- Zero automated tests.
- No coverage config.
- No logger abstraction.

---
## 4. Gap Analysis (Narrative)
The MVP pillars (project discovery, task automation, secrets management, and agent integration) are not yet functional beyond stubs. The current state allows demonstrating feature flag loading and a static representation of projects. Without a real scanner, environment matrix, or dynamic tasks execution, the Copilot agent cannot orchestrate real multi-step flows described in the PRD. Security concerns (keychain, MFA) are deferred; this is acceptable for early development but should be explicitly documented with a mitigation timeline.

---
## 5. Prioritized Remediation Plan (Next 4 Weeks)
### Week 1 (Stabilize Core Config & Data Flow)
1. Add Vitest + first tests (feature flags, simple project DB).  
2. Implement environment matrix loader + `/api/environments`.  
3. Replace hardcoded frontend lists with live fetch (dashboard, projects).  
4. Introduce logger utility (levels + redact helper).  

### Week 2 (Project & Task Foundations)
5. Implement project scanner (pattern-based detection) + FS watch debounce.  
6. Basic task runner (spawn, capture logs, statuses) + WebSocket broadcast.  
7. UI surfaces for task status & log tail.  
8. Decision log service with append endpoint + initial ADR entries.  

### Week 3 (Secrets & Security Layer 1)
9. Secrets provider abstraction + file/JSON backend; plan keychain integration interface.  
10. Audit logging for secret & task events.  
11. API `/api/secrets` rewrite to provider; add create/delete tests.  
12. Add environment variable injection stub for task processes.  

### Week 4 (Integration & Hardening)
13. MCP client placeholder + feature flag gate.  
14. Add environments UI + flag gating in components.  
15. CLI/CI enhancements: test matrix (Node 20/22), coverage thresholds, artifact draft build.  
16. README & DEVELOPMENT docs update + security interim notes.  

### Stretch
- Auto port negotiation for task servers.  
- Partial keychain adapter on at least one platform.  

---
## 6. Risk Register
| Risk | Impact | Likelihood | Mitigation |
| ---- | ------ | ---------- | ---------- |
| Frontend remains static delaying integration | High | Medium | Prioritize dynamic fetch tasks in Week 1 |
| Absence of tests lets regressions slip | High | High | Add Vitest baseline immediately |
| Security debt grows (no keychain) | High | Medium | Document interim model; schedule Secrets Layer 1 in Week 3 |
| Task runner complexity causes delays | Medium | Medium | Start with minimal spawn + log buffer; iterate |
| MCP integration blocked by missing schema | Medium | Medium | Implement placeholder client with mock data early |
| Environment matrix ambiguity | Medium | Low | Define schema & examples in Week 1 |

---
## 7. Concrete Acceptance Targets
- `/api/environments` returns validated structure (dev, stage, prod) within 7 days.
- Frontend dashboard lists real projects from scanner (at least one real detection) within 14 days.
- Task runner can execute `echo Hello` and stream log lines via WebSocket within 14 days.
- Secrets backend supports CRUD (masked read) + audit entries within 21 days.
- Minimum 8 unit tests & 60% line coverage by Day 28.

---
## 8. Technical Debt & Cleanups
| Item | Description | Action |
| ---- | ----------- | ------ |
| Hardcoded UI data | Static arrays impede validation | Replace with hooks + fetch client |
| No logger | Raw console.log everywhere | Introduce logger module + migration plan |
| Mixed line endings risk | CRLF warnings appear | Enforce `.gitattributes` & run lint fix |
| Absent environment loader | Hard to parameterize services | Implement loader + `.env.example` |
| In-memory DB only | Migration risk to Postgres | Abstract repository layer early |

---
## 9. Recommended File/Artifact Additions
- `lib/api.ts` (fetch wrapper)
- `lib/logger.ts`
- `lib/config/loadEnvironments.ts`
- `services/projectScanner.ts`
- `services/taskRunner.ts`
- `services/secretsProvider.ts`
- `services/decisionLog.ts`
- `security/audit.ts`, `security/keychain.ts` (stubs)
- `tests/` folder with initial specs
- `docs/DEVELOPMENT.md`, `docs/SECURITY_NOTES.md`
- `config/features.json` (real file derived from example)
- `infra/environments.example.yaml` + (later) `infra/environments.yaml`

---
## 10. Alignment Notes
The existing feature flag loader and initial endpoints align with the architectural emphasis on configuration-driven behavior. However, environment matrix handling, secrets abstraction, and LangGraph proxy are essential to achieving parity with the blueprint’s runtime orchestration vision. Early introduction of a decision log will support traceability required for automated agents.

---
## 11. Next Immediate Steps (Actionable for Agent)
1. Add Vitest and implement first test (`loadFeatureFlags` valid + invalid).  
2. Create `lib/api.ts` and switch dashboard to live `/api/health` + `/api/flags`.  
3. Implement `loadEnvironments.ts` with schema & `/api/environments`.  
4. Start project scanner skeleton returning current seeded projects + placeholder detection for any `package.json` under workspace.  

---
## 12. Audit Metadata
- Date: 2025-10-04
- Author: Automated audit via Copilot agent
- Branch: current working feature branch
- Scope: Repository root under `dev_wizard/`

---
*End of report.*
